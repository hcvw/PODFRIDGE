---
title: "Sibling analysis"
author: "Manqing Lin"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

Our sibling analysis provides an overview of family size, examining the number of children a mother has and its relationship with the number of sibling each individual has. This tells us the number of first degree relatives each individual has, helping to predict the probability that an individual will be detected in the forensic database.

# Data Exploration

```{r setup, include=FALSE, echo=FALSE}
#knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 6)


# load necessary libraries
library(readr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(viridis)
library(dplyr)
library(knitr)
library(scales)
library(rempsyc)
```


```{r data, results = FALSE,warning=FALSE,message=FALSE}
children_data = read.csv("./data/proportions_table_by_race_year.csv")
mother_data = read.csv("./data/data_filtered_recoded.csv")
```


Here, we are trying to create frequency tables for each race to show the number of children born, the number of mother who has "chborn_num" children, the number of sibling, and the number of individuals who has "n_sib" siblings. 

$$
n_{sib} = chborn_{num} - 1
$$


$$
\text{freq}_{n_{\text{sib}}} = \text{freq}_{\text{mother}} \cdot \text{chborn}_{\text{num}}
$$

For example, suppose 10 mothers (generation 0) have 7 children, then there will be 70 children (generation 1) in total who each have 6 siblings.


## 1.Frequency Table of Number of Children & Siblings of Black/African American Population

```{r}
fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(chborn_num = chborn_num, 
    n_sib = as.integer(if_else(chborn_num == 0, 0, chborn_num - 1)),
    freq_n_sib = n * chborn_num) %>%
  rename(freq_mother = n)

nice_table(
  fert_df[fert_df$RACE == "Black/African American", ],
  title = c("Table 1", "Frequency of Number of Children & Siblings of Black/African American Population")
)
```


## 2.Frequency of Number of Children & Siblings of White Population by Census Year

```{r}
nice_table(
  fert_df[fert_df$RACE == "White", ],
  title = c("Table 2", "Frequency of Number of Children & Siblings of White Population")
)
```



## 3.Summary Statistics of Number of Siblings of Black/African American Population

```{r}
fert_df_sum <- fert_df%>%group_by(RACE, YEAR) %>%
  summarise(
    Mean = sum(freq_n_sib) / sum(freq_mother),
    Variance = sum(freq_mother * (n_sib - Mean)^2) / (sum(freq_mother) - 1), 
    Std_Dev = sqrt(Variance)
    )

nice_table(
  fert_df_sum[fert_df_sum$RACE == "Black/African American", ],
  title = c("Table 3", "Summary Statistics of Number of Siblings of Black/African American Population")
)
```



## 4.Summary Statistics of Number of Siblings of White Population

```{r}
nice_table(
  fert_df_sum[fert_df_sum$RACE == "White", ],
  title = c("Table 4", "Summary Statistics of Number of Siblings of White Population")
)
```

# Data Visualization

## 1.Distribution of Number of Children by Census Year for each Race
```{r chidren, results = FALSE,warning=FALSE,message=FALSE}
ggplot(data = children_data,aes(x=chborn_num,y=proportion)) +
  geom_col(position = position_dodge()) + 
  labs(title = "Distribution of Number of Children by Census Year for each Race") +
  facet_grid(RACE~YEAR) + theme_classic()+
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), 
        plot.title = element_text(size = 10, hjust = 0.5))
```


## 2.Distribution of Number of Sibling by Census Year for each Race

```{r,warning=FALSE,out.width="100%"}
mother_data <- mother_data %>% mutate(id = row_number())
child_df = as.data.frame(rep(mother_data$id,mother_data$chborn_num))
colnames(child_df) = "id"
child_df = merge(child_df,mother_data,by="id")
child_df$nsib = child_df$chborn_num - 1

child_df_gb = child_df %>%
  group_by(RACE,nsib, YEAR) %>%
  summarise(count = n()) 

child_df_gb$prob = ifelse(child_df_gb$RACE == "White",child_df_gb$count/4380009, child_df_gb$count/547692)

ggplot(data = child_df_gb, aes(x = nsib, y = prob)) +
  geom_col(position = position_dodge()) + 
  labs(title = "Distribution of Number of Sibling by Census Year for each Race") +
  facet_wrap(RACE~YEAR) + theme_classic()
```


## 3.Distribution of Number of Children/Siblings by Census Year (Black/African American)

```{r}
colors <- c(
  "#b2d8d8",  # Robin Egg
  "#9FE2BF",  # Seafoam
  "#93C572",  # Pistachio
  "#66C2A5",  # Teal
  "#00A36C",  # Jade
  "#40B5AD",  # Verdigris
  "#088F8F",  # Blue Green
  "#5F9EA0",  # Cadet Blue
  "#5F8575",  # Eucalyptus
  "#8A9A5B",  # Sage
  "#2E8B57",  # Sea Green
  "#454B1B",  # Army Green
  "#355E3B"  # Hunter Green
)
unique_chborn_num <- sort(unique(mother_data$chborn_num))
color_mapping <- setNames(colors, unique_chborn_num)

fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)]) %>%
  rename(freq_mother = n)

#print(fert_df)
```

```{r}
fert_df_black <- fert_df %>% filter(RACE == "Black/African American")
fert_df_white <- fert_df %>% filter(RACE == "White")
  
df_long_black <- fert_df_black %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )

```


```{r}
ggplot(df_long_black, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_black$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (Black/African American)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 10, hjust = 0.5))
```


## 4.Distribution of Number of Children/Siblings by Census Year (Black/African American)

```{r}
df_long_white <- fert_df_white %>%
   pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )
```


```{r}
ggplot(df_long_white, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_white$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (White)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```


## 5.Distribution of Number of Children/Siblings by Age (Balck/African American)

```{r}
fert_df2 <- mother_data %>% mutate(Age_bin = case_when(
    AGE >= 20 & AGE < 30 ~ "20-30",
    AGE >= 30 & AGE < 40 ~ "30-40",
    AGE >= 40 & AGE < 50 ~ "40-50",
    AGE >= 50 & AGE < 60 ~ "50-60",
    AGE >= 60 & AGE < 70 ~ "60-70",
    AGE >= 70 & AGE < 80 ~ "70-80", 
    AGE >= 80 ~ "80"
  ))

fert_df2 <- fert_df2 %>%count(RACE, chborn_num, Age_bin, YEAR) %>%
  arrange(RACE, chborn_num, Age_bin, YEAR) %>%
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)], 
         ) %>% rename(freq_mother = n)

#print(fert_df2)
```


```{r}
fert_df2_black <- fert_df2 %>% filter(RACE == "Black/African American")
fert_df2_white <- fert_df2 %>% filter(RACE == "White")

df_long_black2 <- fert_df2_black %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )

df_long_white2 <- fert_df2_white %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )
```

```{r}
ggplot(df_long_black2, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ Age_bin, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        Age_bin = function(x) paste("Age_bin", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_black2$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Age (Balck/African American)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```


## 6.Distribution of Number of Children/Siblings by Age (White)

```{r}
ggplot(df_long_white2, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ Age_bin, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        Age_bin = function(x) paste("Age_bin", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_white2$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Age (White)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```


```{r}
ggplot(df_long_black2, aes(x = reorder(Age_bin, x_axis), y = frequency, fill = frequency_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  facet_grid(. ~ YEAR) +
  theme_minimal() +
  labs(title = "Distribution of Children Born and Number of Siblings across Age Bins",
       x = "Age Bin",
       y = "Frequency") +
  scale_fill_manual(values = c("freq_mother" = "blue", "freq_n_sib" = "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
#write.csv(df_long_black2, "/Users/linmatch/Desktop/data2.csv", row.names = FALSE)
```

