---
title: "Siblings analysis"
author: "Manqing Lin"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, echo=FALSE}
#knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 6)


# load necessary libraries
library(readr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(viridis)
library(dplyr)
library(knitr)
library(scales)
```


```{r data, results = FALSE,warning=FALSE,message=FALSE}
children_data = read.csv("./data/proportions_table_by_race_year.csv")
mother_data = read.csv("./data/data_filtered_recoded.csv")
```


```{r chidren, results = FALSE,warning=FALSE,message=FALSE}
ggplot(data = children_data,aes(x=chborn_num,y=proportion)) +
  geom_col(position = position_dodge()) +
  facet_grid(RACE~YEAR) + theme_classic()
```

```{r,warning=FALSE,out.width="100%"}
mother_data <- mother_data %>% mutate(id = row_number())
child_df = as.data.frame(rep(mother_data$id,mother_data$chborn_num))
colnames(child_df) = "id"
child_df = merge(child_df,mother_data,by="id")
child_df$nsib = child_df$chborn_num - 1

child_df_gb = child_df %>%
  group_by(RACE,nsib) %>%
  summarise(count = n()) 

child_df_gb$prob = ifelse(child_df_gb$RACE == "White",child_df_gb$count/4380009, child_df_gb$count/547692)

ggplot(data = child_df_gb, aes(x = nsib, y = prob)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~RACE) + theme_classic()
```

# Probability of a person of each race having each number of siblings
```{r,warning=FALSE,results='asis'}
colnames(child_df_gb) = c("Race","Number of Siblings","Count",'Probability')
kable(child_df_gb[,c(1,2,4)])
```

Here, we are trying to create a frequency table to show the number of children born, the number of mother who has "chborn_num" children, the number of sibling, and the number of individuals who has "n_sib" siblings. 

$$
n_{sib} = chborn_{num} - 1
$$

$$
\text{freq}_{n_{\text{sib}}} = \text{freq}_{\text{mother}} \cdot \text{chborn}_{\text{num}}
$$

eg.Suppose 10 mothers (generation 0) has 7 children, then there will be 70 children (generation 1) in total who has 6 siblings. 
```{r}
colors <- c(
  "#8A9A5B",  # Sage
  "#355E3B",  # Hunter Green
  "#5F8575",  # Eucalyptus
  "#66C2A5",  # Teal
  "#088F8F",  # Blue Green
  "#b2d8d8",  # Robin Egg
  "#93C572",  # Pistachio
  "#454B1B",  # Army Green
  "#5F9EA0",  # Cadet Blue
  "#00A36C",  # Jade
  "#9FE2BF",  # Seafoam
  "#2E8B57",  # Sea Green
  "#40B5AD"   # Verdigris

)
unique_chborn_num <- sort(unique(mother_data$chborn_num))
color_mapping <- setNames(colors, unique_chborn_num)

fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)]) %>%
  rename(freq_mother = n)

print(fert_df)
```

```{r}
fert_df_black <- fert_df %>% filter(RACE == "Black/African American")
fert_df_white <- fert_df %>% filter(RACE == "White")
  
df_long_black <- fert_df_black %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )

```


```{r}
ggplot(df_long_black, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_black$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (Black/African American)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 10, hjust = 0.5))
```


```{r}
df_long_white <- fert_df_white %>%
   pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )
```


```{r}
ggplot(df_long_white, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_white$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (White)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```



```{r}
fert_df2 <- mother_data %>% mutate(Age_bin = case_when(
    AGE >= 20 & AGE < 30 ~ "20-30",
    AGE >= 30 & AGE < 40 ~ "30-40",
    AGE >= 40 & AGE < 50 ~ "40-50",
    AGE >= 50 & AGE < 60 ~ "50-60",
    AGE >= 60 & AGE < 70 ~ "60-70",
    AGE >= 70 & AGE < 80 ~ "70-80", 
    AGE >= 80 ~ "80"
  ))

fert_df2 <- fert_df2 %>%count(RACE, chborn_num, Age_bin) %>%
  arrange(RACE, chborn_num, Age_bin) %>%
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)], 
         ) %>% rename(freq_mother = n)

print(fert_df2)
```


```{r}
fert_df2_black <- fert_df2 %>% filter(RACE == "Black/African American")
fert_df2_white <- fert_df2 %>% filter(RACE == "White")

df_long_black2 <- fert_df2_black %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )

df_long_white2 <- fert_df2_white %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )
```

```{r}
ggplot(df_long_black2, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ Age_bin, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        Age_bin = function(x) paste("Age_bin", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_black2$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Age (Balck/African American)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```

```{r}
ggplot(df_long_white2, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ Age_bin, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        Age_bin = function(x) paste("Age_bin", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_white2$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Age (White)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```

