---
title: "Sibling analysis"
author: "Manqing Lin"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

Our sibling analysis provides an overview of family size, examining the number of children a mother has and its relationship with the number of sibling each individual has. This tells us the number of first degree relatives each individual has, helping to predict the probability that an individual will be detected in the forensic database.

# Data Exploration

```{r setup, include=FALSE, echo=FALSE}
#knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 6)


# load necessary libraries
library(readr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(viridis)
library(dplyr)
library(knitr)
library(scales)
library(rempsyc)
library(patchwork)

```


```{r data, results = FALSE,warning=FALSE,message=FALSE}
children_data = read.csv("./data/proportions_table_by_race_year.csv")
mother_data = read.csv("./data/data_filtered_recoded.csv")
```


Here, we are trying to create frequency tables for each race to show the number of children born, the number of mother who has "chborn_num" children, the number of sibling, and the number of individuals who has "n_sib" siblings. 

$$
n_{sib} = chborn_{num} - 1
$$


$$
\text{freq}_{n_{\text{sib}}} = \text{freq}_{\text{mother}} \cdot \text{chborn}_{\text{num}}
$$

For example, suppose 10 mothers (generation 0) have 7 children, then there will be 70 children (generation 1) in total who each have 6 siblings.


## 1.Frequency Table of Number of Children & Siblings of Black/African American Population

```{r}
fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(chborn_num = chborn_num, 
    n_sib = as.integer(if_else(chborn_num == 0, 0, chborn_num - 1)),
    freq_n_sib = n * chborn_num) %>%
  rename(freq_mother = n) 

short_df_black <- fert_df[fert_df$RACE == "Black/African American", ] %>% slice(1:10) 

nice_table(
  short_df_black,
  title = c("Table 1", "Frequency of Number of Children & Siblings of Black/African American Population"), 
  note = c("This table only displays the first 10 rows from the dataset")
)
```


## 2.Frequency Table of Number of Children & Siblings of White Population

```{r}
short_df_white <- fert_df[fert_df$RACE == "White", ] %>% slice(1:10) 

nice_table(
  short_df_white,
  title = c("Table 2", "Frequency of Number of Children & Siblings of White Population"), 
  note = c("This table only displays the first 10 rows from the dataset")
)
```



## 3.Summary Statistics of Number of Siblings of Black/African American Population

```{r}
fert_df_sum <- fert_df%>%group_by(RACE, YEAR) %>%
  summarise(
    Mean = sum(freq_n_sib) / sum(freq_mother),
    Variance = sum(freq_mother * (n_sib - Mean)^2) / (sum(freq_mother) - 1), 
    Std_Dev = sqrt(Variance), .groups = "drop"
    )

nice_table(
  fert_df_sum[fert_df_sum$RACE == "Black/African American", ],
  title = c("Table 3", "Summary Statistics of Number of Siblings of Black/African American Population")
)
```



## 4.Summary Statistics of Number of Siblings of White Population

```{r}
nice_table(
  fert_df_sum[fert_df_sum$RACE == "White", ],
  title = c("Table 4", "Summary Statistics of Number of Siblings of White Population")
)
```


# Data Visualization

## 1.Distribution of Number of Children by Census Year for each Race
```{r chidren, results = FALSE,warning=FALSE,message=FALSE}
ggplot(data = children_data,aes(x=chborn_num,y=proportion)) +
  geom_col(position = position_dodge()) + 
  labs(title = "Distribution of Number of Children by Census Year for each Race", x = "Number of Children") +
  facet_grid(RACE~YEAR) + theme_classic()+
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), 
        plot.title = element_text(size = 12, hjust = 0.5))
```


## 2.Distribution of Number of Sibling by Census Year for each Race
```{r,warning=FALSE,out.width="100%"}
mother_data <- mother_data %>% mutate(id = row_number())
child_df = as.data.frame(rep(mother_data$id,mother_data$chborn_num))
colnames(child_df) = "id"
child_df = merge(child_df,mother_data,by="id")
child_df$nsib = child_df$chborn_num - 1

child_df_gb = child_df %>%
  group_by(RACE,nsib, YEAR) %>%
  summarise(count = n(), .groups = "drop") 

child_df_gb$prob = ifelse(child_df_gb$RACE == "White",child_df_gb$count/4380009, child_df_gb$count/547692)

ggplot(data = child_df_gb, aes(x = nsib, y = prob)) +
  geom_col(position = position_dodge()) + 
  labs(title = "Distribution of Number of Sibling by Census Year for each Race", x = "Number of Sibling", y = "Proportion") +
  facet_grid(RACE~YEAR) + theme_classic()+
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), 
        plot.title = element_text(size = 12, hjust = 0.5))
```


## 3.Distribution of Number of Children/Siblings by Census Year (Black/African American)

```{r}
colors <- c(
  "#b2d8d8",  # Robin Egg
  "#9FE2BF",  # Seafoam
  "#93C572",  # Pistachio
  "#66C2A5",  # Teal
  "#00A36C",  # Jade
  "#40B5AD",  # Verdigris
  "#088F8F",  # Blue Green
  "#5F9EA0",  # Cadet Blue
  "#5F8575",  # Eucalyptus
  "#8A9A5B",  # Sage
  "#2E8B57",  # Sea Green
  "#454B1B",  # Army Green
  "#355E3B"  # Hunter Green
)
unique_chborn_num <- sort(unique(mother_data$chborn_num))
color_mapping <- setNames(colors, unique_chborn_num)

fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)]) %>%
  rename(freq_mother = n)

#print(fert_df)
```

```{r}
fert_df_black <- fert_df %>% filter(RACE == "Black/African American")
fert_df_white <- fert_df %>% filter(RACE == "White")
  
df_long_black <- fert_df_black %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )

```


```{r}
ggplot(df_long_black, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_black$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (Black/African American)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 10, hjust = 0.5))
```


## 4.Distribution of Number of Children/Siblings by Census Year (Black/African American)

```{r}
df_long_white <- fert_df_white %>%
   pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib), 
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = ""), 
         color_order = factor(chborn_num, levels = unique_chborn_num)
  )
```


```{r}
ggplot(df_long_white, aes(x = x_axis, y = frequency, fill = color_order)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", "freq_n_sib" = "Number of Siblings"), 
                        YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(name = "Number of Children/Siblings",
                    values = color_mapping,
                    labels = unique(df_long_white$color.label),
                    guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (White)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        plot.title = element_text(size = 12, hjust = 0.5))
```


## 5.Distribution of Number of Children by Age, Year and RACE

```{r}
fert_df2 <- mother_data %>% mutate(Age_bin = case_when(
    AGE >= 20 & AGE < 30 ~ "20-30",
    AGE >= 30 & AGE < 40 ~ "30-40",
    AGE >= 40 & AGE < 50 ~ "40-50",
    AGE >= 50 & AGE < 60 ~ "50-60",
    AGE >= 60 & AGE < 70 ~ "60-70",
    AGE >= 70 & AGE < 80 ~ "70-80", 
    AGE >= 80 ~ "80"
  ))

fert_df2 <- fert_df2 %>%count(RACE, chborn_num, Age_bin, YEAR) %>%
  arrange(RACE, chborn_num, Age_bin, YEAR) %>%
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)], 
         ) %>% rename(freq_mother = n)

#print(fert_df2)
```


```{r}
fert_df2_black <- fert_df2 %>% filter(RACE == "Black/African American")
fert_df2_white <- fert_df2 %>% filter(RACE == "White")
```
### plot for black
```{r}
df_age_black <- fert_df2_black %>%
  group_by(Age_bin, YEAR, RACE) %>%
  mutate(total_counts = sum(freq_mother),
         normalized_freq = freq_mother / total_counts)

#### plot for black population

df_age_black$RACE <- factor(df_age_black$RACE, levels = c("White", "Black/African American"))

# Data visualization
ggplot(df_age_black, aes(x = normalized_freq, y = factor(YEAR), fill = chborn_num)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  facet_wrap(~Age_bin, scales = "free_y") +
  scale_fill_gradientn(colors = c("#FFF5F0", "#FEE0D2", "#FCBBA1", "#FC9272", "#FB6A4A", "#EF3B2C", "#CB181D", "#99000D"),
    name = "Number of Children") +
  labs(x = "Normalized Frequency", y = "Year", 
       title = "Normalized Distribution of Number of Children by Year and Age Bin (Black)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 10, hjust = 0.5))
```

###plot for white
```{r}
#### plot for white population

df_age_white <- fert_df2_white %>%
  group_by(Age_bin, YEAR, RACE) %>%
  mutate(total_counts = sum(freq_mother),
         normalized_freq = freq_mother / total_counts)

df_age_white$RACE <- factor(df_age_white$RACE, levels = c("White", "Black/African American"))

# Data visualization
ggplot(df_age_white, aes(x = normalized_freq, y = factor(YEAR), fill = chborn_num)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  facet_wrap(~Age_bin, scales = "free_y") +
  scale_fill_gradientn(colors = c("#F7FBFF", "#DEEBF7", "#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5", "#084594"),
  name = "Number of Children") +
  labs(x = "Normalized Frequency", y = "Year", 
       title = "Normalized Distribution of Number of Children by Year and Age Bin (White)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 10, hjust = 0.5))
```

### combine black and white 1
```{r}
df_age <- fert_df2 %>%
  group_by(Age_bin, RACE) %>%
  mutate(total_counts = sum(freq_mother),
         normalized_freq = freq_mother / total_counts)

df_age$RACE <- factor(df_age$RACE, levels = c("White", "Black/African American"))

```

```{r}
# Data visualization
ggplot(df_age, aes(x = normalized_freq, y = factor(YEAR), fill = chborn_num, color = RACE)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  facet_wrap(~Age_bin, scales = "free_y") +
  scale_fill_gradientn(colors = c("#FFF5F0", "#FEE0D2", "#FCBBA1", "#FC9272", "#FB6A4A", "#EF3B2C", "#CB181D", "#99000D"), name = "Number of Children") +
  scale_color_manual(values = c("blue", "red"), name = "Race") +
  labs(x = "Normalized Frequency", y = "Year", 
       title = "Normalized Distribution of Number of Children by Year, Age Bin, and Population") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 10, hjust = 0.5))

```

### combine black and white 2
```{r}
ggplot(df_age, aes(x = normalized_freq, y = factor(YEAR), fill = RACE, alpha = chborn_num)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Age_bin, scales = "free_y") +
  scale_fill_manual(values = c("Black/African American" = "red", "White" = "blue")) +
  scale_alpha_continuous(range = c(0.3, 1)) +
  labs(x = "Normalized Frequency", y = "Year", 
       title = "Normalized Distribution of Number of Children by Year, Age Bin, and Population", 
       fill = "Race",
       alpha = "Number of Children Born") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 10, hjust = 0.5))
```

### combine black and white 3
```{r}
black_colors <- c("#FFF5F0", "#FEE0D2", "#FCBBA1", "#FC9272", "#FB6A4A", "#EF3B2C", "#CB181D", "#99000D")
white_colors <- c("#F7FBFF", "#DEEBF7", "#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5", "#084594")

# Map chborn_num to a color gradient within each race
df_age2 <- df_age %>%
  mutate(color = case_when(
    RACE == "Black/African American" ~ cut(chborn_num, breaks = length(black_colors), labels = black_colors),
    RACE == "White" ~ cut(chborn_num, breaks = length(white_colors), labels = white_colors)
  ))
```


```{r}
# Create the ggplot
ggplot(df_age2, aes(x = normalized_freq, y = factor(YEAR), fill = color)) +
  geom_bar(stat = "identity", alpha = 0.8) +
  facet_wrap(~Age_bin, scales = "free_y") +
  scale_fill_identity() +
  labs(x = "Normalized Frequency", y = "Year", 
       title = "Normalized Distribution of Number of Children by Year, Age Bin, and Population", 
       fill = "Race") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
ggplot() +
  # Layer for Black/African American
  geom_bar(data = df_age %>% filter(RACE == "Black/African American"),
           aes(x = normalized_freq, y = factor(YEAR), fill = chborn_num, alpha = chborn_num),
           stat = "identity", position = "stack") +
  scale_fill_gradientn(colors = c("#FFF5F0", "#FEE0D2", "#FCBBA1", "#FC9272", "#FB6A4A", "#EF3B2C", "#CB181D", "#99000D")) +
  new_scale_fill() +
  # Layer for White
  geom_bar(data = df_age %>% filter(RACE == "White"),
           aes(x = normalized_freq, y = factor(YEAR), fill = chborn_num, alpha = chborn_num),
           stat = "identity", position = "stack") +
  scale_fill_gradientn(colors = c("#F7FBFF", "#DEEBF7", "#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5", "#084594")) +
  scale_alpha_continuous(range = c(0.3, 1)) +
  facet_wrap(~Age_bin, scales = "free_y") +
  labs(title = "Stacked Bar Chart with Transparency and Custom Colors",
       x = "Normalized Frequency",
       y = "Year",
       fill = "Number of Children Born",
       alpha = "Number of Children Born") +
  theme_minimal()
```


## 6. Distribution of Number of Mother By Age and Census Year
```{r}
mother_df <- fert_df2 %>% group_by(Age_bin, YEAR, RACE) %>%
  summarise(freq_mother = sum(freq_mother), .groups = "drop") %>%
  mutate(freq_mother = ifelse(RACE == "Black/African American", -freq_mother, freq_mother))

```

```{r}
max_freq <- max(abs(mother_df$freq_mother))

ggplot(mother_df, aes(x = freq_mother, y = Age_bin, fill = RACE)) +
  geom_col() +
  scale_fill_manual(values = c("Black/African American" = "#2E8B57", "White" = "#b2d8d8"), name = "Race") +
  scale_x_continuous(labels = function(x) label_number()(abs(x)), 
                     limits = c(-max_freq, max_freq)) +
  facet_wrap(~ YEAR, scales = "free_y") +
  labs(title = "Distribution of Mother by Census Year and Age Bin",
       x = "Number of Mothers",
       y = "Age Bin") +
  theme_minimal() +
  theme(legend.position = "right", axis.text.x = element_text(size = 7, angle = 45, hjust = 1), plot.title = element_text(size = 10, hjust = 0.5))
```

```{r}

```


