---
title: "Sibling analysis"
author: "Manqing Lin"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

Our sibling analysis provides an overview of family size, examining the number of children a mother has and its relationship with the number of sibling each individual has. This tells us the number of first degree relatives each individual has, helping to predict the probability that an individual will be detected in the forensic database.

# Data Exploration

```{r setup, include=FALSE, echo=FALSE}
#knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 6)


# load necessary libraries
library(readr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(viridis)
library(dplyr)
library(knitr)
library(scales)
library(rempsyc)
library(patchwork)
library(ggnewscale)
library(gridExtra)
```


```{r data, results = FALSE,warning=FALSE,message=FALSE}
children_data = read.csv("./data/proportions_table_by_race_year.csv")
mother_data = read.csv("./data/data_filtered_recoded.csv")
```


Here are the frequency tables for each race to show the number of children born, the number of mother who has "chborn_num" children, the number of sibling, and the number of individuals who has "n_sib" siblings. 

$$
n_{sib} = chborn_{num} - 1
$$


$$
\text{freq}_{n_{\text{sib}}} = \text{freq}_{\text{mother}} \cdot \text{chborn}_{\text{num}}
$$

For example, suppose 10 mothers (generation 0) have 7 children, then there will be 70 children (generation 1) in total who each have 6 siblings.


## 1.Frequency Table of Number of Children & Siblings of Black/African American Population
```{r}
fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(chborn_num = chborn_num, 
    n_sib = as.integer(if_else(chborn_num == 0, 0, chborn_num - 1)),
    freq_n_sib = n * chborn_num) %>%
  rename(freq_mother = n) 

short_df_black <- fert_df[fert_df$RACE == "Black/African American", ] %>% slice(1:10) 

nice_table(
  short_df_black,
  title = c("Table 1", "Frequency of Number of Children & Siblings of Black/African American Population"), 
  note = c("This table only displays the first 10 rows from the original dataset")
)
```


## 2.Frequency Table of Number of Children & Siblings of White Population
```{r}
short_df_white <- fert_df[fert_df$RACE == "White", ] %>% slice(1:10) 

nice_table(
  short_df_white,
  title = c("Table 2", "Frequency of Number of Children & Siblings of White Population"), 
  note = c("This table only displays the first 10 rows from the original dataset")
)
```


The following summary statistics tables describe the racial breakdown of average number of siblings that individuals have across census year. 

## 3.Summary Statistics of Number of Siblings of Black/African American Population
```{r}
fert_df_sum <- fert_df%>%group_by(RACE, YEAR) %>%
  summarise(
    Mean = sum(freq_n_sib) / sum(freq_mother),
    Variance = sum(freq_mother * (n_sib - Mean)^2) / (sum(freq_mother) - 1), 
    Std_Dev = sqrt(Variance), .groups = "drop"
    )

nice_table(
  fert_df_sum[fert_df_sum$RACE == "Black/African American", ],
  title = c("Table 3", "Summary Statistics of Number of Siblings of Black/African American Population")
)
```


## 4.Summary Statistics of Number of Siblings of White Population
```{r}
nice_table(
  fert_df_sum[fert_df_sum$RACE == "White", ],
  title = c("Table 4", "Summary Statistics of Number of Siblings of White Population")
)
```
>Note: On average, individuals from White population have smaller number of siblings than Black/African American Population across all census year. 


# Data Visualization

## 1.Distribution of Number of Children by Census Year for each Race
```{r}
my_colors <- gradient_n_pal(c("#FFB000", "#F77A2E", "#DE3A8A", "#7253FF", "#5E8BFF"))(seq(0, 1, length.out = 13))
```


```{r chidren, results = FALSE,warning=FALSE,message=FALSE}
ggplot(data = children_data,aes(x=chborn_num,y=proportion, fill = as.factor(chborn_num))) +
  geom_col(position = position_dodge()) + 
  labs(title = "Distribution of Number of Children by Census Year for each Race", x = "Number of Children", y = "Proportion", caption = "Footnote: The category '12 Number of Children' includes families with 12 or more children.") +
  facet_grid(RACE~YEAR, scales = "free_y") + theme_classic()+
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), 
        plot.title = element_text(size = 12, hjust = 0.5), 
        plot.caption = element_text(hjust=0))+
  scale_fill_manual(values = my_colors, name = "Number of Children")
```
> Note: The graph shows racial disparities in family size. Black/African American families consistently have a higher proportion of larger families compared to White families across all census years.Larger family sizes, may result in a higher number of first-degree relatives (siblings). This can increase the probability of detecting individuals in forensic databases.


## 2.Distribution of Number of Sibling by Census Year for each Race
```{r,warning=FALSE,out.width="100%"}
mother_data <- mother_data %>% mutate(id = row_number())
child_df = as.data.frame(rep(mother_data$id,mother_data$chborn_num))
colnames(child_df) = "id"
child_df = merge(child_df,mother_data,by="id")
child_df$nsib = child_df$chborn_num - 1

child_df_gb = child_df %>%
  group_by(RACE,nsib, YEAR) %>%
  summarise(count = n(), .groups = "drop") 

child_df_gb$prob = ifelse(child_df_gb$RACE == "White",child_df_gb$count/4380009, child_df_gb$count/547692)

ggplot(data = child_df_gb, aes(x = nsib, y = prob, fill = as.factor(nsib)))+
  geom_col(position = position_dodge()) + 
  labs(title = "Distribution of Number of Sibling by Census Year for each Race", x = "Number of Sibling", y = "Proportion", caption = "Footnote: The category '11 Number of Siblings' includes individuals with 11 or more siblings.") +
  facet_grid(RACE~YEAR, scales = "free_y") + theme_classic()+
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), 
        plot.title = element_text(size = 12, hjust = 0.5), 
        plot.caption = element_text(hjust=0))+
  scale_fill_manual(values = my_colors, name = "Number of Siblings")
```
> Note: Both Black/African American and White populations has diminishing trend of having larger sibling groups over the decades. However, the graph indicates differences in sibling numbers between the two racial groups. Black/African American individuals are more likely to have larger numbers of siblings across all census years compared to White individuals.


## 3.Comparison of Frequency across YEAR for 50-60
```{r}
fert_df2 <- mother_data %>% mutate(Age_bin = case_when(
    AGE >= 20 & AGE < 30 ~ "20-30",
    AGE >= 30 & AGE < 40 ~ "30-40",
    AGE >= 40 & AGE < 50 ~ "40-50",
    AGE >= 50 & AGE < 60 ~ "50-60",
    AGE >= 60 & AGE < 70 ~ "60-70",
    AGE >= 70 & AGE < 80 ~ "70-80", 
    AGE >= 80 ~ "80"
  ))

fert_df2 <- fert_df2 %>%count(RACE, chborn_num, Age_bin, YEAR) %>%
  arrange(RACE, chborn_num, Age_bin, YEAR) %>%
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num) %>% rename(freq_mother = n)

df_50_60 <- fert_df2 %>% filter(Age_bin == "50-60")%>%
  group_by(RACE, YEAR) %>%
  mutate(
    total_chborn = sum(freq_mother),
    norm_chborn_freq = freq_mother / total_chborn,
    total_sibs = sum(freq_n_sib),
    norm_sib_freq = freq_n_sib / total_sibs
  ) %>%
  pivot_longer(
    cols = c(freq_mother, freq_n_sib),
    names_to = "frequency_type",
    values_to = "frequency"
  ) %>%
  mutate(
    norm_freq = ifelse(frequency_type == "freq_mother", norm_chborn_freq, norm_sib_freq)) %>%
  ungroup()  
```


### Plot for Number of Children
```{r}
ggplot(subset(df_50_60, frequency_type == "freq_mother"), aes(x = chborn_num, y = norm_freq, fill = as.factor(YEAR))) +
  geom_col(position = "dodge")+ 
  facet_wrap(~ RACE, ncol=1, scales = "free_y") +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "#009E73"), name = "YEAR") +
  scale_x_continuous(breaks = 0:12) + 
  labs(title = "Comparison of Normalized Frequencies by YEAR and RACE(Mother Aged 50-60)",
       x = "Number of Children",
       y = "Normalized Frequency", 
       caption = "Footnote: The category '12 Number of Children' includes families with 12 or more children.")  +
  theme_minimal()+
  theme(plot.title = element_text(size = 10, hjust = 0.5), 
         plot.caption = element_text(hjust=0))
```
> Note: Focusing on mothers in the 50-60 age range, the graph shows that family size in both racial group has generally decreased over time, with fewer families having a large number of children in the more recent years (1980 and 1990). In addition, it also shows a racial disparity between racial groups. Black/African American families consistently have a higher proportion of larger families compared to White families across all years.


### Plot for Number of Siblings
```{r}
ggplot(subset(df_50_60, frequency_type == "freq_n_sib"), aes(x = n_sib, y = norm_freq, fill = as.factor(YEAR))) +
  geom_col(position = "dodge")+ 
  facet_wrap(~ RACE, ncol=1, scales = "free_y") +
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9", "#009E73"), name = "YEAR") +
  scale_x_continuous(breaks = 0:12) + 
  labs(title = "Comparison of Normalized Frequencies by YEAR and RACE(Mother Aged 50-60)",
       x = "Number of Siblings",
       y = "Normalized Frequency", 
       caption = "Footnote: The category '11 Number of Siblings' includes individuals with 11 or more siblings.")  +
  theme_minimal()+
  theme(plot.title = element_text(size = 10, hjust = 0.5), 
         plot.caption = element_text(hjust=0))
```
>Note: Focusing on mothers in the 50-60 age range, the graph shows a significant change in the distribution of number of siblings across decades. Particularly by 1990, there is a noticeable shift toward smaller sibling groups in both racial groups. The graph also shows a clear racial disparity in number of siblings. In the earlier census year, a higher proportion of Black/African American individuals have a larger number of siblings. However, individuals in white population display a steeper decline in the number of siblings as we move towards more recent years. 
