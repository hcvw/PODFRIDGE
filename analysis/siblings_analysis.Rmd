---
title: "Siblings analysis"
author: "Manqing Lin"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data, results = FALSE,warning=FALSE,message=FALSE}
# load necessary libraries
library(readr)
library(tidyverse)
library(tidyr)
library(ggplot2)
library(viridis)
library(dplyr)
library(knitr)
library(scales)

children_data = read.csv("./data/proportions_table_by_race_year.csv")
mother_data = read.csv("./data/data_filtered_recoded.csv")
```


```{r chidren, results = FALSE,warning=FALSE,message=FALSE}
ggplot(data = children_data,aes(x=chborn_num,y=proportion)) +
  geom_col(position = position_dodge()) +
  facet_grid(RACE~YEAR) + theme_classic()
```

```{r,warning=FALSE,out.width="100%"}
mother_data <- mother_data %>% mutate(id = row_number())
child_df = as.data.frame(rep(mother_data$id,mother_data$chborn_num))
colnames(child_df) = "id"
child_df = merge(child_df,mother_data,by="id")
child_df$nsib = child_df$chborn_num - 1

child_df_gb = child_df %>%
  group_by(RACE,nsib) %>%
  summarise(count = n()) 

child_df_gb$prob = ifelse(child_df_gb$RACE == "White",child_df_gb$count/4380009, child_df_gb$count/547692)

ggplot(data = child_df_gb, aes(x = nsib, y = prob)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~RACE) + theme_classic()
```

# Probability of a person of each race having each number of siblings
```{r,warning=FALSE,results='asis'}
colnames(child_df_gb) = c("Race","Number of Siblings","Count",'Probability')
kable(child_df_gb[,c(1,2,4)])
```

Here, we are trying to create a frequency table to show the number of children born, the number of mother who has "chborn_num" children, the number of sibling, and the number of individuals who has "n_sib" siblings. 
- n_sib = chborn_num - 1
- freq_n_sib = freq_mother * chborn_num
eg.Suppose 10 mothers (generation 0) has 7 children, then there will be 70 children (generation 1) in total who has 6 siblings. 
```{r}
colors <- c(
  "#E41A1C",  # Red
  "#377EB8",  # Blue
  "#4DAF4A",  # Green
  "#984EA3",  # Purple
  "#FF7F00",  # Orange
  "#FFFF33",  # Yellow
  "#A65628",  # Brown
  "#F781BF",  # Pink
  "#999999",  # Grey
  "#66C2A5",  # Teal
  "#FC8D62",  # Salmon
  "#8DA0CB",  # Light blue
  "#E78AC3"   # Light pink
)
unique_chborn_num <- sort(unique(mother_data$chborn_num))
color_mapping <- setNames(colors, unique_chborn_num)

fert_df <- mother_data %>%
  count(RACE, YEAR, chborn_num) %>%
  arrange(RACE, YEAR, chborn_num) %>% 
  mutate(n_sib = chborn_num -1, freq_n_sib = n * chborn_num, 
         color = color_mapping[as.character(chborn_num)],
         color.label = paste(chborn_num, "_kids"," ", n_sib, "_sibs", sep = "")) %>%
  rename(freq_mother = n)

print(fert_df)
```

```{r}
fert_df_black <- fert_df %>% filter(RACE == "Black/African American")
fert_df_white <- fert_df %>% filter(RACE == "White")
  
df_long_black <- fert_df_black %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib))

```

```{r}
ggplot(df_long_black, aes(x = x_axis, y = frequency, fill = color)) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", 
                                                    "freq_n_sib" = "Number of Siblings"),
                                 YEAR = function(x) paste("Year", x))) +
  scale_fill_identity(name = "Number of Children/Siblings",
                      labels = df_long_black$color.label,
                      guide = "legend") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (Black/African American)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right")
```

```{r}
df_long_white <- fert_df_white %>%
  pivot_longer(cols = c(freq_mother, freq_n_sib),
               names_to = "frequency_type",
               values_to = "frequency") %>%
  mutate(x_axis = ifelse(frequency_type == "freq_mother", chborn_num, n_sib))
```

```{r}
ggplot(df_long_white, aes(x = x_axis, y = frequency, fill = as.factor(x_axis))) +
  geom_col() +
  facet_grid(frequency_type ~ YEAR, scales = "free", 
             labeller = labeller(frequency_type = c("freq_mother" = "Number of Children Born", 
                                                    "freq_n_sib" = "Number of Siblings"),
                                 YEAR = function(x) paste("Year", x))) +
  scale_fill_manual(values = color_mapping, name = "Number of Children/Siblings") +
  scale_y_continuous(labels = comma_format(scale = 1, big.mark = ",")) +
  labs(title = "Distribution of Number of Children/Siblings by Census Year (White)",
       x = "Number of Children/Siblings",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right")
```

