---
title: "Database composition"
author: "Tina Lasisi, Stella BooydeGraaff"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Load required packages
library(tidyverse)
library(patchwork)

knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 6)

```

# Forensic

Data based on Murphy & Tong


## Analysis of Demographic Group Representation in Database vs Population

This document presents an analysis of the representation of various demographic groups in a database compared to their representation in the general population across different states.

### Data Loading and Preparation

We start by loading the necessary libraries and the dataset.

```{r}
library(tidyverse)

# Load the dataset
data <- read_csv("data/df_state-breakdown.csv")
data_total <- read_csv("data/df_state_total.csv")
```

### Data Cleaning
The data contains demographic information with percentages in two contexts: 'Database' and 'Population'. We need to clean and transform the data for analysis.

```{r}
# Convert the 'Value' column to numeric
data <- data %>%
  mutate(Value = as.numeric(str_remove(Value, "%")) / 100)

# Separate the data into database and population datasets
database_data <- data %>% filter(Context == "Database")
population_data <- data %>% filter(Context == "Population")

# Merge the two datasets
merged_data <- database_data %>%
  inner_join(population_data, by = c("State", "Demographic Group")) %>%
  rename(Value_Database = Value.x, Value_Population = Value.y) %>%
  mutate(Difference = Value_Database - Value_Population)

```

### Data Visualization
We create a visualization to show the differences in representation for each demographic group by state.

```{r}
# Plotting the differences
ggplot(merged_data, aes(x = State, y = Difference, fill = `Demographic Group`)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  theme_minimal() +
  labs(title = "Difference in Demographic Group Representation: Database vs Population by State",
       x = "State", y = "Difference in Representation") +
  geom_hline(yintercept = 0, linetype = 1)

```

### Summary Table
Finally, we create a summary table showing the difference in representation for each state and demographic group.

```{r}
# Creating the summary table
state_group_summary <- merged_data %>%
  group_by(State, `Demographic Group`) %>%
  summarize(Difference = mean(Difference)) %>%
  ungroup()

state_group_summary
```

### Summary of representation across Forensic and DTC databases

```{r}
# CONFIGURE CONSTANTS

# Total US Population 1990: source?
US_POP_1990 = 2.5e8

# European American Population 1990: source?
EA_POP_1990 = 199686070
  
# African American Population 1990: source?
AA_POP_1990 = 29986060

# calculate proportion of us population each group
US_PROP_AA = AA_POP_1990 / US_POP_1990
US_PROP_EA = EA_POP_1990 / US_POP_1990

# CODIS SIZE 
CODIS_SIZE = 2.10e7

# DTC SIZE 
ANCESTRY_SIZE = 2.3e7
TWTY_THREE_ME_SIZE = 1.4e7
MY_HERATIGE_SIZE = 7e6
FTDNA = 1.8e6
GEDMATCH = 1.8e6

# calculate total DTC SIZE
DTC_SIZE = ANCESTRY_SIZE + TWTY_THREE_ME_SIZE + MY_HERATIGE_SIZE + FTDNA + GEDMATCH

# calculate searchable DTC size (FTDNA + GEDMATCH)
DTC_SEARCH = FTDNA + GEDMATCH

# Proportion AA in CODIS
PROP_AA_CODIS = 0.236

# Proportion EA in CODIS
PROP_EA_CODIS = 0.429

### TODO: UPDATE THESE WITH CORRECT VALUES
PROP_AA_DTC = 0.03 # TODO: need this value
PROP_EA_DTC = 0.60 # TODO: need this value

### TODO: UPDATE THESE NUMBERS WITH CORRECT VALUES
PROP_AA_DTC_S = 0.03
PROP_EA_DTC_S = 0.60
```

```{r forensic-database-composition}

# OPTION 1 

# plot relative composition of the database types

PROPS <- c(PROP_EA_CODIS, PROP_EA_DTC, PROP_AA_CODIS, PROP_AA_DTC, PROP_AA_DTC_S, PROP_EA_DTC_S)
DATABASE <- c("CODIS", "DTC", "CODIS", "DTC", "DTCS", "DTCS")
POPULATION <- c("European American", "European American", "African American", "African American", "African American", "European American")

data = tibble(PROPS, DATABASE, POPULATION)
# Reorder the levels of POPULATION
data$POPULATION <- factor(data$POPULATION, levels = c("European American", "African American"))

ggplot(data, aes(y=PROPS, fill=POPULATION)) + 
  geom_col(aes(x=DATABASE, group=POPULATION), position = position_dodge2()) + 
  labs(title = "Genetic database composition for European and African Americans",
         x = "Population",
         y = "Proportion of Database",
         color = "Database") +
    theme_minimal() + 
    scale_y_continuous(limits = c(0, 1))

```

# Direct-to-Consumer Database Statistics

## Accessibility of Direct-to-Consumer Databases

```{r}
dtc_access <- read_csv("data/DTC_access_export.csv", show_col_types = FALSE) 
```

```{r}
dtc_access_cleaned <- dtc_access |> 
  select(-Source_Link, -Comments) |> 
  drop_na() |> 
  mutate(summary = case_when(
    pub_access == "yes" ~ "Public Access",
    law_access == "yes" ~ "Law Enforcement Access",
    pub_access == "no" & law_access == "no" ~ "Neither"
  ))

```

Each Direct-to-Consumer company has different policies on whether their databases are accessible to law enforcement or to the public. The following chart shows the ratio of which of the six main companies allow for which group to access them.

```{r}

ggplot(dtc_access_cleaned, aes(x = "", fill = summary)) +
  geom_bar(width = 1, stat = "count") +  # Use 'count' to plot the frequencies
  coord_polar(theta = "y") +  # Convert bar chart into a pie chart
  labs(title = "Access Summary Distribution", fill = "Access Summary") +
  theme_void() +  # Remove background and axis
  scale_fill_manual(values = c("Public Access" = "#DE3A8A", 
                               "Law Enforcement Access" = "#FFB000",
                               "Neither" = "#7253FF"))

```


The companies that law enforcement can access are FamilyTreeDNA and GEDmatch. FamilyTreeDNA allows users to opt out but have a history of violating their Terms of Service. GEDmatch also sells access to law enforcement and has a history of violating their Terms of Service, but since the law enforcement used this database to find the Golden State Killer in 2018, they have created an opt-in option for sharing data with law enforcement.

The company whose database is open to the public is MyHeritage. Genetic data is not publicly available, but records such as birth, marriage, death, burial, census, military, immigration, yearbooks are. Family sites and certain settings can allow for publicly accessible genetic data as well.

The other Direct-to-Consumer companies are characterized as allowing access to neither law enforcement or the public. Ancestry DNA requires valid legal reasoning to share data with law enforcement. 23andMe has an opt-in option for scientific researcher that 81% of users do. Living DNA shares anonymous data with third parties, and has an opt-in option to share data with researchers, however, they do not sell data to law enforcement unless feel they are legally compelled.

## Direct-to-Consumer Database Total Size

```{r}
dtc_race <- read_csv("data/DTC_race_export.csv", show_col_types = FALSE)
```

The following graph demonstrates the total number of people in each Direct-to-Consumer Database. AncestryDNA has the largest DNA database at 25,000,000. The second-largest database is 23andMe, which has 10,000,000 DNA samples. Living DNA has the smallest database, with 300,000 DNA samples.

```{r}
dtc_race_cleaned <- dtc_race |> 
  select(-Source_link, -Comments) |> 
  drop_na()

dtc_race_totals <- dtc_race_cleaned |> 
  filter(pop == "Total")

ggplot(dtc_race_totals, aes(x = Database, y = value)) +
  geom_col(fill = "#F77A2E") +
  geom_text(aes(label = scales::comma(value)),
            vjust = -0.5,  # above the bar
            size = 2.5) +  # text size
  scale_y_continuous(labels = scales::comma, breaks = seq(0, 25000000, by = 5000000)) +
  labs(title = "Database Size Totals",
       x = "Database",
       y = "Number of People",
       caption = "*These values were measured in varying years between 2021 and 2024") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```


Another option is to show this on a log scale:

```{r}
ggplot(dtc_race_totals, aes(x = Database, y = value)) +
  geom_col(fill = "#F77A2E") +
  geom_text(aes(label = scales::comma(value)),
            vjust = -0.5,  # above the bar
            size = 2.5) +  # text size
  scale_y_continuous(trans = 'log10', labels = scales::comma) +
  labs(title = "Database Size Totals (log scale)",
       x = "Database",
       y = "Number of People (log scale)") +
  theme_minimal()

```

## Racial Composition of Direct-to-Consumer Databases

Most Direct-to-Consumer companies do not publish the racial or gender breakdown of their DNA samples. We have data from the 23andMe Research Innovation Collaborations and Replications Program, which is a portion of their database used for scientific research. The total number of DNA samples in this cohort is 8,000,000. The racial breakdown of this sample of the 23andMe database is shown below.

```{r}
dtc_23andMe <- dtc_race_cleaned |> 
  filter(Database == "23andMe", trimws(pop) != "Total") |> 
  mutate(proportion = value / sum(value)) |> 
  mutate(pop = factor(pop, levels = c('Other', 'West Asian and North African', 'Hispanic', 'Asian', 'Black', 'White')))

ggplot(dtc_23andMe, aes(x = Database, y = proportion, fill = pop)) +
  geom_col() +
  geom_text(aes(label = scales::comma(value)), position = position_stack(vjust = 0.5), color = "black", size = 1.5) +
  labs(title = "Racial Composition of 23andMe Database",
       x = "Database",
       y = "Proportion",
       fill = "Race Category") +
  theme_minimal() +
  scale_fill_manual(values = c("#5E8BFF1A", "#5E8BFF33", "#5E8BFF66","#5E8BFF80", "#5E8BFF", "#DE3A8A")) +
  theme(plot.title = element_text(hjust = 0.5))

```

From this data, we see that the majority of the 23andMe database is White (67.5%), then the order of biggest proportion to smallest proportion is Hispanic (16.4%), Black (5.5%), Asian (5%), Other (4.6%), and West Asian and North African (1%).

