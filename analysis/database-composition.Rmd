---
title: "Estimates of DTC Demographics"
author: "Tina Lasisi, Stella BooydeGraaff"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Load required packages
library(tidyverse)
library(patchwork)
library(knitr)
library(kableExtra)

#knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 6)

```

# Introduction : Direct-to-Consumer Database Statistics

In this analysis, we present our estimates regarding direct-to-consumer (DTC) genetic testing databases. Our approach consists of three main components:

1. We use published data from 23andMe as a foundation to estimate the proportions of African Americans (or Black Americans) and European Americans (or White Americans) in DTC databases. These proportions form the basis for our subsequent analyses.

2. We compile and present data on major DTC companies, including their reported database sizes and policies on law enforcement accessibility. This information helps us estimate the total size of DTC databases and the portion that might be accessible to law enforcement, which is crucial for the analyses in our manuscript.

3. Finally, we synthesize this information to estimate the number and proportion of African Americans and European Americans represented across all DTC databases, as well as those accessible to law enforcement.

## Data Sources

Our analysis draws on several key sources:

1. Bryc et al. (2014) and Zhang et al. (2024): These studies utilized 23andMe databases and provide information on the self-identified ethnic and racial groups of participants.

2. Tung et al. (2011) "Characteristics of an Online Consumer Genetic Research Cohort": This poster, presented at the 2011 American Society of Human Genetics (ASHG) meeting by 23andMe representatives, forms the basis for our assumption of 80% European American representation in DTC databases. We use this assumption to calibrate relative proportions of other demographic groups.

3. Publicly available information from DTC companies regarding their database sizes and law enforcement access policies.

By combining these sources, we aim to provide a comprehensive overview of the demographic composition of DTC genetic databases and their potential implications for genetic research and forensic applications.

## Accessibility of Direct-to-Consumer Databases

```{r}
# Import the comprehensive demographics data
demographics_data <- read_csv("data/dtc_demographics.csv")

# Separate the data into different dataframes
bryc_data <- demographics_data |>
  filter(Source == "Bryc2014")
zhang_data <- demographics_data |>
  filter(Source == "Zhang2024")
census_data <- demographics_data|>
  filter(Source == "Census2020")

# Calculate totals and proportions for each dataset
calculate_proportions <- function(df) {
  df |> 
    mutate(Total = sum(Number_of_Customers),
           Proportion = Number_of_Customers / Total * 100)
}

bryc_data <- calculate_proportions(bryc_data)
zhang_data <- calculate_proportions(zhang_data)
census_data <- calculate_proportions(census_data)

# Display the processed data
kable(bryc_data, caption = "Bryc et al. (2014) Data") |> 
  kable_styling(bootstrap_options = c("striped", "hover"))

kable(zhang_data, caption = "Zhang et al. (2024) Data") |> 
  kable_styling(bootstrap_options = c("striped", "hover"))

kable(census_data, caption = "U.S. Census Data (2020)") |> 
  kable_styling(bootstrap_options = c("striped", "hover"))
```


```{r}
# Calculate total customers for each source
totals <- demographics_data |> 
  filter(Source != "Census2020") |> 
  group_by(Source) |> 
  summarise(Total_Customers = sum(Number_of_Customers), .groups = "drop")

# Merge totals back to the main data
data_23andMe <- demographics_data |> 
  filter(Source != "Census2020") |> 
  left_join(totals, by = "Source")

# Calculate proportions for each ethnicity
data_23andMe <- data_23andMe |> 
  mutate(Proportion = (Number_of_Customers / Total_Customers) * 100)

# Calculate ratios for European American to African American and Latino
ratios <- data_23andMe |> 
  filter(Ethnicity %in% c("European American", "African American", "Latino")) |> 
  select(Source, Ethnicity, Number_of_Customers) |> 
  pivot_wider(names_from = Ethnicity, values_from = Number_of_Customers) |> 
  mutate(
    EA_AA_Ratio = `European American` / `African American`,
    EA_Latino_Ratio = `European American` / `Latino`
  )

# Display the calculated proportions and ratios
kable(data_23andMe, caption = "23andMe Demographics: Customer Numbers and Proportions") |> 
  kable_styling(bootstrap_options = c("striped", "hover"))

kable(ratios, caption = "Ratios of European American to African American and Latino Customers") |> 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

```{r}
# Set total sample size and European American proportion
T <- 100000
EA <- 0.80 * T  # 80% European American

# Use ratios from the more recent study (Zhang2024)
EA_AA_Ratio <- ratios$EA_AA_Ratio[ratios$Source == "Zhang2024"]
EA_Latino_Ratio <- ratios$EA_Latino_Ratio[ratios$Source == "Zhang2024"]

# Calculate other ethnicities based on the ratios
AA <- EA / EA_AA_Ratio
Latino <- EA / EA_Latino_Ratio
Other <- T - (EA + AA + Latino)

# Calculate proportions
AA_Prop <- (AA / T) * 100
Latino_Prop <- (Latino / T) * 100
Other_Prop <- (Other / T) * 100

# Create a tibble with calibrated data
calibrated_data <- tibble(
  Ethnicity = c("European American", "African American", "Latino", "Other"),
  Number_of_Customers = c(EA, AA, Latino, Other),
  Proportion = c(80, AA_Prop, Latino_Prop, Other_Prop)
)

# Display the calibrated data
kable(calibrated_data, caption = "Calibrated Estimates Assuming 80% European American") |> 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

We're creating a calibrated estimate assuming European Americans represent 80% of the samples. This assumption is based on [a poster presented at ASHG 2011](, which can be found at this link). We use the ratios from [the more recent Zhang 2024 study](https://www.nature.com/articles/s41467-024-47357-7#MOESM4) to estimate the proportions of other ethnicities.

```{r}
#dtc_access <- read_csv("data/DTC_access_export.csv", show_col_types = FALSE) 
```

```{r}
dtc_access_cleaned <- dtc_access |> 
  select(-Source_Link, -Comments) |> 
  drop_na() |> 
  mutate(summary = case_when(
    pub_access == "yes" ~ "Public Access",
    law_access == "yes" ~ "Law Enforcement Access",
    pub_access == "no" & law_access == "no" ~ "Neither"
  ))

```

Each Direct-to-Consumer company has different policies on whether their databases are accessible to law enforcement or to the public. The following chart shows the ratio of which of the six main companies allow for which group to access them.

```{r}

ggplot(dtc_access_cleaned, aes(x = "", fill = summary)) +
  geom_bar(width = 1, stat = "count") +  # Use 'count' to plot the frequencies
  coord_polar(theta = "y") +  # Convert bar chart into a pie chart
  labs(title = "Access Summary Distribution", fill = "Access Summary") +
  theme_void() +  # Remove background and axis
  scale_fill_manual(values = c("Public Access" = "#DE3A8A", 
                               "Law Enforcement Access" = "#FFB000",
                               "Neither" = "#7253FF"))

```


The companies that law enforcement can access are FamilyTreeDNA and GEDmatch. FamilyTreeDNA allows users to opt out but have a history of violating their Terms of Service. GEDmatch also sells access to law enforcement and has a history of violating their Terms of Service, but since the law enforcement used this database to find the Golden State Killer in 2018, they have created an opt-in option for sharing data with law enforcement.

The company whose database is open to the public is MyHeritage. Genetic data is not publicly available, but records such as birth, marriage, death, burial, census, military, immigration, yearbooks are. Family sites and certain settings can allow for publicly accessible genetic data as well.

The other Direct-to-Consumer companies are characterized as allowing access to neither law enforcement or the public. Ancestry DNA requires valid legal reasoning to share data with law enforcement. 23andMe has an opt-in option for scientific researcher that 81% of users do. Living DNA shares anonymous data with third parties, and has an opt-in option to share data with researchers, however, they do not sell data to law enforcement unless feel they are legally compelled.

## Direct-to-Consumer Database Total Size

```{r}
dtc_race <- read_csv("data/DTC_race_export.csv", show_col_types = FALSE)
```

The following graph demonstrates the total number of people in each Direct-to-Consumer Database. AncestryDNA has the largest DNA database at 25,000,000. The second-largest database is 23andMe, which has 10,000,000 DNA samples. Living DNA has the smallest database, with 300,000 DNA samples.

```{r}
dtc_race_cleaned <- dtc_race |> 
  select(-Source_link, -Comments) |> 
  drop_na()

dtc_race_totals <- dtc_race_cleaned |> 
  filter(pop == "Total")

ggplot(dtc_race_totals, aes(x = Database, y = value)) +
  geom_col(fill = "#F77A2E") +
  geom_text(aes(label = scales::comma(value)),
            vjust = -0.5,  # above the bar
            size = 2.5) +  # text size
  scale_y_continuous(labels = scales::comma, breaks = seq(0, 25000000, by = 5000000)) +
  labs(title = "Database Size Totals",
       x = "Database",
       y = "Number of People",
       caption = "*These values were measured in varying years between 2021 and 2024") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```


Another option is to show this on a log scale:

```{r}
ggplot(dtc_race_totals, aes(x = Database, y = value)) +
  geom_col(fill = "#F77A2E") +
  geom_text(aes(label = scales::comma(value)),
            vjust = -0.5,  # above the bar
            size = 2.5) +  # text size
  scale_y_continuous(trans = 'log10', labels = scales::comma) +
  labs(title = "Database Size Totals (log scale)",
       x = "Database",
       y = "Number of People (log scale)") +
  theme_minimal()

```

## Racial Composition of Direct-to-Consumer Databases

Most Direct-to-Consumer companies do not publish the racial or gender breakdown of their DNA samples. We have data from the 23andMe Research Innovation Collaborations and Replications Program, which is a portion of their database used for scientific research. The total number of DNA samples in this cohort is 8,000,000. The racial breakdown of this sample of the 23andMe database is shown below.

```{r}
dtc_23andMe <- dtc_race_cleaned |> 
  filter(Database == "23andMe", trimws(pop) != "Total") |> 
  mutate(proportion = value / sum(value)) |> 
  mutate(pop = factor(pop, levels = c('Other', 'West Asian and North African', 'Hispanic', 'Asian', 'Black', 'White')))

ggplot(dtc_23andMe, aes(x = Database, y = proportion, fill = pop)) +
  geom_col() +
  geom_text(aes(label = scales::comma(value)), position = position_stack(vjust = 0.5), color = "black", size = 1.5) +
  labs(title = "Racial Composition of 23andMe Database",
       x = "Database",
       y = "Proportion",
       fill = "Race Category") +
  theme_minimal() +
  scale_fill_manual(values = c("#5E8BFF1A", "#5E8BFF52", "#5E8BFF85","#5E8BFFC4", "#5E8BFF", "#DE3A8A")) +
  theme(plot.title = element_text(hjust = 0.5))

```

From this data, we see that the majority of the 23andMe database is White (67.5%), then the order of biggest proportion to smallest proportion is Hispanic (16.4%), Black (5.5%), Asian (5%), Other (4.6%), and West Asian and North African (1%).

