---
title: "Disparities in the probability of finding a relative via long-range familial search"
author: "Junhui He"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
site: workflowr::wflow_site
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# load package
library(ggplot2)
```

## 1 Objective

We aims to determine the difference in the probability of finding a match in a direct-to-consumer (DTC) genetic database for Black and White Americans. This analysis integrates family size distributions (from Result 2), database representation disparities (from Result 1B), and considers the proportion of DTC databases accessible to law enforcement.

We establish a theoretical binomial model $\text{Bin}(K,p)$ to calculate the probability of finding a match in a database, where $K$ is the size of the database and $p$ is the match probability between a target and another individual. The match probability $p$ is calculated based on the population size, the database size, racial representation disparities, and the family size distribution.

## 2 Model assumptions

1.  In the current generation, the population size is $N$, and the racial proportion of the population is $\alpha$.

2.  The database has $K$ individuals, and the racial proportion of the database is $\beta$. The database is randomly sampled from the current population.

3.  The family trees of different races are strictly separated. For instance, the ancestors and descendants of black Americans are also black Americans.

4.  We assume that there is no inter-marriage in the family involved, except for the known ancestor couple of the target.

5.  The number of children per couple at the generation $g$ before the present is $r_g$. In this model, we estimate $r_1$ by the children number of 1990 age-range 40-49 women, $r_2$ by the children number of 1960 age-range 40-49 women, $r_3$ by the children number of 1960 age-range 70+ women and $r_g$ has the same distribution as $r_3$ for $g\geq 3$. Additionally, if a certain couple is known as the ancestors of the target, it has at least one child.

6.  Individuals are diploid and we consider only the autosomal genome.

7.  The genome of the target individual is compared to those of all individuals in the database, and identical-by-descent (IBD) segments are identified. We assume that detectable segments must be of length $\geq$ $m$ (in Morgans). We further assume that in order to confidently detect the relationship (a "match"), we must observe at least $s$ such segments

8.  We only consider relationships for which the common ancestors have lived $g\leq g_{\max}$ generations ago. For example, $g=1$ for siblings, $g=2$ for first cousins, etc. All cousins/siblings are full.

9.  We only consider regular cousins, excluding once removed and so on.

10. The number of matches between the target and the individuals in the database is counted. If we have more than $t$ matches, we declare that there is sufficient information to trace back the target. Typically, we simply assume $t=1$.

## 3 Derivation

### 3.1 The probability of a sharing a pair of ancestor

Consider the cousins of the target. $g$ generations before the present, the target has $2^{g-1}$ ancestral couples. For example, each individual has one pair of parents ($g=1$), two pairs of grandparents ($g=2$), four pairs of great-grandparents ($g=3$) and so on. Each ancestral couple contributes to $(r_g-1) \prod_{i=1}^{g-1} r_i$ of the $(g-1)$-th cousins of the target. For example, consider a pair of grandparents ($g=2$), each individual has $(r_2-1)$ uncles/aunts, and hence $(r_2-1)r_1$ first cousins. Note that $r_g \geq 1$. Therefore, the total number of the $(g-1)$-th cousins is given by

$$\text{The number of the $(g-1)$ cousins}=2^{g-1}(r_g-1) \prod_{i=1}^{g-1} r_i.$$

Under the assumption of separated family trees and randomly sampled database, given the family size, the probability to share an ancestral couple for the first time at generation $g$ between the target and the individual in the database with the same race is approximately:

$$P(\text{first sharing a mating pair at $g$ for a certain race}|r)=\frac{2^{g-1}(r_g-1) \prod_{i=1}^{g-1} r_i}{\alpha N}.$$

### 3.2 The probability of a match given a shared mating pair

This probability is irrelevant with the race. We adopt the estimation in the paper of Erlich et al. 2018. To declare a match, we need at least $s$ segments of at least length $m$. Thus, given a first shared mating pair $g$ generations ago, the probability to observe a match is

$$P(\text{match}|g)=1-\sum_{k=0}^{s-1} \text{Bin}(k;2Lg+22,\frac{\exp(-2mg)}{2^{2g-2}}),$$ where $L$ is the total genome length, roughly $L=35$.

### 3.3 The match probability between a target and a individual from the same race

Given the family size, the probability of declaring a match between the target and a random individual in the database is simply the sum of the product over all $g$,

$$ P(\text{match}|r)=\sum_{g=1}^{g_{\max}} P(\text{match}|g) \frac{2^{g-1}(r_g-1) \prod_{i=1}^{g-1} r_i}{\alpha N}. $$

The number of matches to a database is assumed to follow a binomial distribution defined as

$$ \text{Bin}(\beta K, P(\text{match}|r)) .$$

To identify an individual, we need to find at least $t$ matches in the database. Thus, given the family size,

$$P(\text{identify}|r)=1-\sum_{k=1}^{t-1} \text{Bin}(k;\beta K, P(\text{match}|r)).$$

We utilize Monte Carlo methods to calculate the mean probability of identifying an individual over family size, i.e., $E[P(\text{identify}|r)]$.

Additionally, we calculate $P(\text{identify}|\bar{r})$ to make a comparison with $E[P(\text{identify}|r)]$, where $\bar{r}$ represents the mean number of children. This probability $P(\text{identify}|\bar{r})$ is used in the paper of Erlich et al. 2018, if we substitute $\bar{r}$ by a constant $r$.

## 4 Experimental results

```{r match-prob}
# Define genome size and number of chromosomes
genome_size = 35 
num_chrs = 22

# calculate the number of the (g-1)-th cousins (view siblings as the 0-th cousins) with family size r
count_cousins <- function(g, r) {
  k_ancestor_couple = 2^(g-1)
  k_cousins = k_ancestor_couple*(r[g]-1) # remove the descendants of the p-th ancestor
  if(g>1) {
    for(i in 1:(g-1)) {
      k_cousins = k_cousins * r[i]
    }
  }
  return(k_cousins)
} 

# calculate the probability of observing a match
genetic_match <- function(g, m, min_num_seg) {
  m = m / 100 # Convert m from cM to fraction
  f = exp(-2 * g * m) / 2^(2 * g - 2) # calculate the probability of sharing a detectable IBD segment
  pr = 1 - pbinom(min_num_seg - 1, num_chrs + genome_size * 2 * g, f) # calculate probability
  return(pr)
}

# calculate the match probability of the (g-1)-th cousins
match_prob <- function(g, r, N, m, min_num_seg) {
  p_genetic = genetic_match(g, m, min_num_seg)
  p_genealogic = count_cousins(g, r) / N
  p_match = p_genetic * p_genealogic
  return(p_match)
}

# calculate the probability of find at least min_num_rel relatives up to the (gmax-1)-th cousins
coverage <- function(gmax, N, K, r, m, min_num_seg, min_num_rel) {
  if(length(r)==1) {
    r = rep(r, gmax)
  }
  tot_p_match = 0
  
  # calculate the match probability up to the (gmax-1)-th cousins
  for(g in 1:gmax) {
    tot_p_match = tot_p_match + match_prob(g, r, N, m, min_num_seg)
  }
  
  pr_success = 1 - pbinom(min_num_rel-1, K, tot_p_match) # probability of success
  return(pr_success)
}
```

```{r data}
# read racial compositions in Census and DTC database (Result 1b)
racial_composition = read.csv(file.path("output", "demographic_composition_comparison.csv"))

# population proportions
pop_props = racial_composition$Proportion[c(1,3)]
# DTC proportions
dtc_props = racial_composition$Proportion[c(10, 12)]
# population size
N = sum(racial_composition$Number_of_Customers[1:4])

# read family size distributions for black/white Americans (Result 2)
family_size = read.csv(file.path("data", "family_size.csv"))

black_family_size = rbind(family_size$proportion[which(family_size$RACE=="Black/African American" & family_size$YEAR=="1990" & family_size$AGE_RANGE=="40-49")],
                          family_size$proportion[which(family_size$RACE=="Black/African American" & family_size$YEAR=="1960" & family_size$AGE_RANGE=="40-49")],
                          family_size$proportion[which(family_size$RACE=="Black/African American" & family_size$YEAR=="1960" & family_size$AGE_RANGE=="70+")])

white_family_size = rbind(family_size$proportion[which(family_size$RACE=="White" & family_size$YEAR=="1990" & family_size$AGE_RANGE=="40-49")],
                          family_size$proportion[which(family_size$RACE=="White" & family_size$YEAR=="1960" & family_size$AGE_RANGE=="40-49")],
                          family_size$proportion[which(family_size$RACE=="White" & family_size$YEAR=="1960" & family_size$AGE_RANGE=="70+")])
```

```{r monte-carlo}
# calculate the distribution of match probabilities using Monte Carlo methods
coverage_samples <- function(num_sample, family_size, gmax, tot_N, tot_K, pop_prop, dtc_prop, m, min_num_seg, min_num_rel) {
  N = round(tot_N * pop_prop) # population size of certain race
  K = round(tot_K * dtc_prop) # database size of certain race
  
  cov_sam = rep(NA, num_sample)
  g_family = dim(family_size)[1]
  
  for (i in 1:num_sample) {
    tot_p_match = 0
    for (g in 1:gmax) {
      # sample a family size
      r = rep(NA, g)
      if(g > 1) {
        for(k in 1:(g-1)) {
          r[k] = which.max(rmultinom(1,1,family_size[min(k,g_family),])) - 1
        }
      }
      r[g] = which.max(rmultinom(1,1,family_size[min(g,g_family),-1]))
      tot_p_match = tot_p_match + match_prob(g, r, N, m, min_num_seg)
    }
    
    # calculate coverage
    cov_sam[i] = 1 - pbinom(min_num_rel-1, K, tot_p_match)
  }
  
  return(cov_sam)
}
```

```{r match-parameters}
num_sample = 1e4 #number of Monte Carlo samples
K_props = seq(0,1,length.out=100) #database/population
Ks = round(N*K_props) #DTC database size
m = 6 #minimal cM
min_num_seg = 2 #number of segments
min_num_rel = 1 #number of relatives
gmaxs = c(2:5) #number of generations
```

```{r identify-probability}
pr_black = array(dim = c(length(gmaxs), length(K_props)))
pr_white = array(dim = c(length(gmaxs), length(K_props)))
pr_black_pse = array(dim = c(length(gmaxs), length(K_props)))
pr_white_pse = array(dim = c(length(gmaxs), length(K_props)))
r_black = sapply(1:3, function(i) {return(sum(black_family_size[i,]*c(0:12)))})
r_white = sapply(1:3, function(i) {return(sum(white_family_size[i,]*c(0:12)))})
for(i in 1:length(K_props)) {
  for(j in 1:length(gmaxs)) {
    cov_black = coverage_samples(num_sample, black_family_size, gmaxs[j], N, Ks[i], pop_props[2], dtc_props[2], m, min_num_seg, min_num_rel)
    pr_black[j, i] = mean(cov_black)
    cov_white = coverage_samples(num_sample, white_family_size, gmaxs[j], N, Ks[i], pop_props[1], dtc_props[1], m, min_num_seg, min_num_rel)
    pr_white[j, i] = mean(cov_white)
    
    pr_black_pse[j, i] = coverage(gmaxs[j], round(N*pop_props[2]), round(0.1*Ks[i]*dtc_props[2]), c(r_black, rep(r_black[3], max(0, gmaxs[j]-3))), m, min_num_seg, min_num_rel)
    pr_white_pse[j, i] = coverage(gmaxs[j], round(N*pop_props[1]), round(0.1*Ks[i]*dtc_props[1]), c(r_white, rep(r_white[3], max(0, gmaxs[j]-3))), m, min_num_seg, min_num_rel)
  }
}
```

1.  The mean probability of identifying an individual over the family size up to a certain type of cousinship from a database, $E[P(\text{identify}|r)]$, considering the population size, the database size and the race

```{r plot-probability}
black_df = data.frame(prob=c(pr_black), prop=rep(K_props, each=length(gmaxs)), cousin=factor(rep(gmaxs-1, length(K_props))), race=factor("Black American"))
white_df = data.frame(prob=c(pr_white), prop=rep(K_props, each=length(gmaxs)), cousin=factor(rep(gmaxs-1, length(K_props))), race=factor("White American"))
prob_df = rbind(black_df, white_df)

ggplot(prob_df, aes(x=prop, y=prob)) + geom_line(aes(colour=cousin, linetype=race)) + xlab("Database size/population size") + ylab("Probability of identifying an individual") + ggtitle("The mean probability of identifying an individual from a database")
```

2.  The pseudo probability of identifying an individual using a mean family size up to a certain type of cousinship from a database, $P(\text{identify}|\bar{r})$, considering the population size, the database size and the race

```{r plot-pseudo-probability}
pse_black_df = data.frame(prob=c(pr_black_pse), prop=rep(0.1*K_props, each=length(gmaxs)), cousin=factor(rep(gmaxs-1, length(K_props))), race=factor("Black American"))
pse_white_df = data.frame(prob=c(pr_white_pse), prop=rep(0.1*K_props, each=length(gmaxs)), cousin=factor(rep(gmaxs-1, length(K_props))), race=factor("White American"))
pse_prob_df = rbind(pse_black_df, pse_white_df)

ggplot(pse_prob_df, aes(x=prop, y=prob)) + geom_line(aes(colour=cousin, linetype=race)) + xlab("Database size/population size") + ylab("Probability of identifying an individual") + ggtitle("The pseudo probability of identifying an individual using a mean family size from a database")
```

## 5 Conclusions

1.  The identification probability for White Americans is significantly higher than that for Black Americans, primarily due to disparities in database representation.

2.  The value of $P(\text{identify}|\bar{r})$ is notably higher than $E[P(\text{identify}|r)]$, highlighting the importance of considering family size as a complete distribution in the analysis.
