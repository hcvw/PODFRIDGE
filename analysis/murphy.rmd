---
title: "Murphy Data Cleaning"
author: "Stella BooydeGraaff"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, echo=FALSE}

knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 6)

library(tidyverse)
library(wesanderson)
```

```{r}
data <- read_csv("data/Murphy_Appendix_all_data.csv") 

head(data)
```

```{r} 
data <- data |>
  select(-file) 

head(data)
```

```{r}
  data <- data %>%
      mutate(
          # Check if 'proportion' is in the variable_detailed
          is_proportion = grepl("proportion", variable_detailed, ignore.case = TRUE),
          
          # Create value_type based on the presence of 'proportion'
          value_type = ifelse(is_proportion, 
                              "proportion", 
                              "number"),
          
          # Remove 'proportion' text from variable_detailed
          variable_detailed = ifelse(is_proportion, gsub("proportion", "", variable_detailed, ignore.case = TRUE), variable_detailed),
          
          # Trim whitespace
          variable_detailed = trimws(variable_detailed),
          
          # cleaned variable_detailed to numeric
          variable_detailed_numeric = suppressWarnings(as.numeric(variable_detailed)),
          
          # Update value_type to "number" if variable_detailed_numeric is greater than 1
          value_type = ifelse(!is.na(variable_detailed_numeric) & variable_detailed_numeric > 1, 
                              "number", 
                              value_type)
      ) %>%
      # Drop temporary columns
      select(-is_proportion, -variable_detailed_numeric)

```

```{r}
data <- data %>%
    rename(variable_type = variatble_type)

```

```{r}
#race
data <- data %>%
  mutate(
    variable_detailed = case_when(
      variable_type == "race" & grepl("\\basian\\b", variable_detailed, ignore.case = TRUE) ~ "asian_total",
      variable_type == "race" & grepl("\\bblack\\b", variable_detailed, ignore.case = TRUE) ~ "black_total",
      variable_type == "race" & grepl("\\bafrican_american\\b", variable_detailed, ignore.case = TRUE) ~ "black_total",
      variable_type == "race" & grepl("\\bblack_\\b", variable_detailed, ignore.case = TRUE) ~ "black_total",
      variable_type == "race" & grepl("\\bhispanic\\b", variable_detailed, ignore.case = TRUE) ~ "hispanic_total",
      variable_type == "race" & grepl("\\bhispanic_\\b", variable_detailed, ignore.case = TRUE) ~ "hispanic_total",
      variable_type == "race" & grepl("\\bnative\\b", variable_detailed, ignore.case = TRUE) ~ "native_american_total",
      variable_type == "race" & grepl("\\bamerican_indian\\b", variable_detailed, ignore.case = TRUE) ~ "native_american_total",
       variable_type == "race" & grepl("\\bnative_american\\b", variable_detailed, ignore.case = TRUE) ~ "native_american_total",
      variable_type == "race" & grepl("\\bwhite\\b", variable_detailed, ignore.case = TRUE) ~ "white_total",
      variable_type == "race" & grepl("\\bcausasian\\b", variable_detailed, ignore.case = TRUE) ~ "white_total",
      variable_type == "race" & grepl("\\bcausasian_\\b", variable_detailed, ignore.case = TRUE) ~ "white_total",
      variable_type == "race" & grepl("\\bother\\b", variable_detailed, ignore.case = TRUE) ~ "other_total",
      variable_type == "race" & grepl("\\basian_offender\\b", variable_detailed, ignore.case = TRUE) ~ "asian_convicted_offender",
      variable_type == "race" & grepl("\\bblack_offender\\b", variable_detailed, ignore.case = TRUE) ~ "black_convicted_offender",
      variable_type == "race" & grepl("\\bhispanic_offender\\b", variable_detailed, ignore.case = TRUE) ~ "hispanic_convicted_offender",
      variable_type == "race" & grepl("\\bnative_american_offender\\b", variable_detailed, ignore.case = TRUE) ~ "native_american_convicted_offender",
      variable_type == "race" & grepl("\\bwhite_offender\\b", variable_detailed, ignore.case = TRUE) ~ "white_convicted_offender",
      variable_type == "race" & grepl("\\bcaucasian_offender\\b", variable_detailed, ignore.case = TRUE) ~ "white_convicted_offender",
      variable_type == "race" & grepl("\\bcaucasian_convicted_offender\\b", variable_detailed, ignore.case = TRUE) ~ "white_convicted_offender",
      variable_type == "race" & grepl("\\bother_offender\\b", variable_detailed, ignore.case = TRUE) ~ "other_convicted_offender",
      variable_type == "race" & grepl("\\bafrican_american__convicted_offender\\b", variable_detailed, ignore.case = TRUE) ~ "black_convicted_offender",
      variable_type == "race" & grepl("\\bafrican_american_offender\\b", variable_detailed, ignore.case = TRUE) ~ "black_convicted_offender",
      variable_type == "race" & grepl("\\bafrican_american_arrestee\\b", variable_detailed, ignore.case = TRUE) ~ "black_arrestee",
      variable_type == "race" & grepl("\\bcaucasian_arrestee\\b", variable_detailed, ignore.case = TRUE) ~ "white_arrestee",
      TRUE ~ variable_detailed
    ))
    
#DNA collection breakdown
data <- data %>%
  mutate(
    variable_detailed = case_when(
      variable_type == "DNA_collection_breakdown" & grepl("asian", variable_detailed, ignore.case = TRUE) ~ "asian_annual",
      variable_type == "DNA_collection_breakdown" & grepl("black", variable_detailed, ignore.case = TRUE) ~ "black_annual",
      variable_type == "DNA_collection_breakdown" & grepl("hispanic", variable_detailed, ignore.case = TRUE) ~ "hispanic_annual",
      variable_type == "DNA_collection_breakdown" & grepl("native", variable_detailed, ignore.case = TRUE) ~ "native_american_annual",
      variable_type == "DNA_collection_breakdown" & grepl("white", variable_detailed, ignore.case = TRUE) ~ "white_annual",
      variable_type == "DNA_collection_breakdown" & grepl("other", variable_detailed, ignore.case = TRUE) ~ "other_annual",
      TRUE ~ variable_detailed
    )
  )
    
```

```{r}
# Update 'variable_type' to 'race' where it is 'DNA_collection_breakdown'

data <- data %>%
  mutate(
    variable_type = ifelse(variable_type == "DNA_collection_breakdown", "race", variable_type))
```

```{r}
#state demographic
data <- data %>%
  mutate(
    variable_detailed = case_when(
      variable_type == "state_demographic" & grepl("asian", variable_detailed, ignore.case = TRUE) ~ "asian_state",
      variable_type == "state_demographic" & grepl("black", variable_detailed, ignore.case = TRUE) ~ "black_state",
      variable_type == "state_demographic" & grepl("hispanic", variable_detailed, ignore.case = TRUE) ~ "hispanic_state",
      variable_type == "state_demographic" & grepl("native", variable_detailed, ignore.case = TRUE) ~ "native_american_state",
      variable_type == "state_demographic" & grepl("white", variable_detailed, ignore.case = TRUE) ~ "white_state",
      variable_type == "state_demographic" & grepl("other", variable_detailed, ignore.case = TRUE) ~ "other_state",
      TRUE ~ variable_detailed
    )
  )

```

```{r}
# Update 'variable_type' to 'race' where it is 'state_demographic'

data <- data %>%
  mutate(
    variable_type = ifelse(variable_type == "state_demographic", "race", variable_type))
```

```{r}
#population data collected variables
data <- data %>%
  mutate(
    variable_detailed = case_when(
      variable_type == "population_data_collected" & grepl("asian", variable_detailed, ignore.case = TRUE) ~ "asian_pop_collected",
      variable_type == "population_data_collected" & grepl("black", variable_detailed, ignore.case = TRUE) ~ "black_pop_collected",
      variable_type == "population_data_collected" & grepl("hispanic", variable_detailed, ignore.case = TRUE) ~ "hispanic_pop_collected",
      variable_type == "population_data_collected" & grepl("native", variable_detailed, ignore.case = TRUE) ~ "native_american_pop_collected",
      variable_type == "population_data_collected" & grepl("white", variable_detailed, ignore.case = TRUE) ~ "white_pop_collected",
      variable_type == "population_data_collected" & grepl("other", variable_detailed, ignore.case = TRUE) ~ "other_pop_collected",
      TRUE ~ variable_detailed
    )
  )
```

```{r}
# Update 'variable_type' to 'race' where it is 'population_data_collected'

data <- data %>%
  mutate(
    variable_type = ifelse(variable_type == "population_data_collected", "race", variable_type))
```

```{r}
#sex variable type
data <- data %>%
  mutate(
    variable_detailed = case_when(
      variable_type == "sex" & grepl("\\bfemale\\b", variable_detailed, ignore.case = TRUE) ~ "female_total",
      variable_type == "sex" & grepl("\\bfemale_\\b", variable_detailed, ignore.case = TRUE) ~ "female_total",
      variable_type == "sex" & grepl("\\bfemales\\b", variable_detailed, ignore.case = TRUE) ~ "female_total",
      variable_type == "sex" & grepl("\\bfemale_offender\\b", variable_detailed, ignore.case = TRUE) ~ "female_convicted_offender",
      variable_type == "sex" & grepl("\\bmale\\b", variable_detailed, ignore.case = TRUE) ~ "male_total",
      variable_type == "sex" & grepl("\\bmale_\\b", variable_detailed, ignore.case = TRUE) ~ "male_total",
      variable_type == "sex" & grepl("\\bmales\\b", variable_detailed, ignore.case = TRUE) ~ "male_total",
      TRUE ~ variable_detailed 
    )
  )
```

```{r}
data <- data %>%
  mutate(
    variable_type = ifelse(variable_type == "gender", "sex", variable_type))
```

```{r}
data <- data %>%
  mutate(
    variable_detailed = case_when(
      variable_type == "offender_type" & grepl("\\barrestee\\b", variable_detailed, ignore.case = TRUE) ~ "arrestee_total",
      variable_type == "offender_type" & grepl("\\barrested_offender\\b", variable_detailed, ignore.case = TRUE) ~ "arrestee_total",
      variable_type == "offender_type" & grepl("\\bconvicted_offender\\b", variable_detailed, ignore.case = TRUE) ~ "convicted_offender_total",
      variable_type == "offender_type" & grepl("\\bconviceted_offender\\b", variable_detailed, ignore.case = TRUE) ~ "convicted_offender_total",
      variable_type == "offender_type" & grepl("\\boffender\\b", variable_detailed, ignore.case = TRUE) ~ "convicted_offender_total",
      TRUE ~ variable_detailed 
    )
  )
```

```{r}
incorrect_entries <- data_race |> 
  filter(!variable_detailed %in% c("asian_total", "black_total", "hispanic_total", "native_american_total", "white_total", "other_total", "unknown",
      "asian_convicted_offender", "black_convicted_offender", "hispanic_convicted_offender", "native_american_convicted_offender", "white_convicted_offender", "other_convicted_offender",
      "asian_arrestee", "black_arrestee", "hispanic_arrestee", "native_american_arrestee", "white_arrestee", "other_arrestee",
      "asian_annual", "black_annual", "hispanic_annual", "native_american_annual", "white_annual", "other_annual",
      "asian_state", "black_state", "hispanic_state", "native_american_state", "white_state", "other_state",
      "asian_pop_collected", "black_pop_collected", "hispanic_pop_collected", "native_american_pop_collected", "white_pop_collected", "other_pop_collected"))

# View incorrect entries
print(incorrect_entries)
```

```{r}
write.csv(data, "data/murphy_foia_cleaned.csv")
```


```{r}
#data visualizations
data_gender <- data |> 
  filter(variable_type == "sex")


california_totals <- data_gender |> 
  filter(State == "California") |> 
  summarise(
    male_total = sum(value[grepl("male", variable_detailed, ignore.case = TRUE)]),
    female_total = sum(value[grepl("female", variable_detailed, ignore.case = TRUE)]),
    unknown_total = sum(value[grepl("unknown", variable_detailed, ignore.case = TRUE)])
  ) 
```


```{r}
california_totals <- california_totals |>  
  pivot_longer(cols = everything(), names_to = "variable_detailed", values_to = "value")|> 
  mutate(
    State = "California",
    variable_type = "sex",
    value_type = "proportion"
  )
```

```{r}
#create a dataset with gender values as proportions only
data_gender_proportions <- data_gender  |> 
  group_by(State, variable_type, value_type) |>   # Group by relevant columns
  mutate(proportion = value / sum(value)) |>      # Calculate proportion
  ungroup() |>                                    # Ungroup to prevent grouping in the output
  select(-value, -value_type)|>                   # remove the value and value_type columns
  rename(proportion_value = proportion)           # Rename the new proportion column


data_gender_simplified <- data_gender_proportions |> 
  mutate(
 simplified_sex = case_when(
      str_detect(variable_detailed, "\\bmale\\b") ~ "male",
      str_detect(variable_detailed, "\\bmale_total\\b") ~ "male",
      str_detect(variable_detailed, "\\bmale_convicted_offender\\b") ~ "male",
      str_detect(variable_detailed, "\\bmale_arrestee\\b") ~ "male",
      str_detect(variable_detailed, "\\bfemale_total\\b") ~ "female",
      str_detect(variable_detailed, "\\bfemale_convicted_offender\\b") ~ "female",
      str_detect(variable_detailed, "\\bfemale_offender\\b") ~ "female",
      str_detect(variable_detailed, "\\bfemale_arrestee\\b") ~ "female",
      str_detect(variable_detailed, "\\bfemale\\b") ~ "female",
      TRUE ~ "unknown"
    )
  ) |> 
  group_by(State, simplified_sex) |> 
  summarize(total_value = sum(proportion_value), .groups = 'drop')

selected_colors <- wes_palette("Moonrise3")[c(2, 3, 5)]

#stacked bar chart simplified
ggplot(data_gender_simplified, aes(x = State, y = total_value, fill = simplified_sex)) +
  geom_bar(stat = "identity") +  # Stacked bar chart by default
  scale_fill_manual(values = selected_colors) +  # color palette
  labs(y = "Proportion", x = "State", title = "NDIS Gender Distribution by State", fill = "Sex") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
data_race <- data |> 
  filter(variable_type == "race")

data_race_proportions <- data_race |> 
  group_by(State) |> 
  mutate(proportion_value = ifelse(value_type == "number", value / sum(value), NA))

# Combine original proportions with newly calculated ones
data_race_proportions <- data_race_proportions |> 
  mutate(proportion_value = ifelse(is.na(proportion_value), value, proportion_value)) |> 
  select(-value_type)  

```


```{r}
data_offender_type <- data |> 
  filter(variable_type == "offender_type")


#pie chart of offender type

palette <- wes_palette("GrandBudapest2", 3, type = "discrete")

# Rename the offender types
data_offender_type_renamed <- data_offender_type |> 
  mutate(variable_detailed = case_when(
    variable_detailed == "arrestee_total" ~ "Arrestee",
    variable_detailed == "convicted_offender_total" ~ "Convicted Offender",
    TRUE ~ variable_detailed
  ))

# Filter and group by offender type, then summarize
data_offender_type_summarized <- data_offender_type_renamed |> 
  filter(variable_detailed %in% c("Arrestee", "Convicted Offender")) |> 
  group_by(variable_detailed) |> 
  summarize(total_value = sum(value, na.rm = TRUE))

# Calculate total sum of the summarized data
full_value <- sum(data_offender_type_summarized$total_value, na.rm = TRUE)

# Calculate percentages and create labels
data_offender_type_summarized <- data_offender_type_summarized |> 
  mutate(percentage = total_value / full_value * 100,
         label = paste0(round(percentage, 1), "%"))

# Create the pie chart
ggplot(data_offender_type_summarized, aes(x = "", y = total_value, fill = variable_detailed)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +  # Converts bar chart to pie chart
  labs(title = "NDIS Distribution of Offender Types", caption = "Data from California, Indiana, Texas, and Nevada", fill = "Offender Type") +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank()) +
  scale_fill_manual(values = palette)

```

```{r}


```


